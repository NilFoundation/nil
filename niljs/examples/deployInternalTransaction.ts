import type { Abi } from "abitype";
import {
  HttpTransport,
  type ProcessedReceipt,
  PublicClient,
  bytesToHex,
  generateSmartAccount,
} from "../src/index.js";
import { FAUCET_ENDPOINT, RPC_ENDPOINT, generatePublicKey } from "./helpers.js";

const client = new PublicClient({
  transport: new HttpTransport({
    endpoint: RPC_ENDPOINT,
  }),
  shardId: 1,
});

const smartAccount = await generateSmartAccount({
  shardId: 1,
  rpcEndpoint: RPC_ENDPOINT,
  faucetEndpoint: FAUCET_ENDPOINT,
});
const smartAccountAddress = smartAccount.address;

console.log("smartAccountAddress", smartAccountAddress);

console.log("Smart account deployed successfully");

console.log(await client.getCode(smartAccountAddress, "latest"));

const pubKey = generatePublicKey();

const abi = [
  {
    inputs: [
      { internalType: "bytes", name: "_pubkey", type: "bytes" },
      { internalType: "address", name: "_owner", type: "address" },
    ],
    stateMutability: "payable",
    type: "constructor",
  },
] as Abi;
const { address, tx } = await smartAccount.deployContract({
  bytecode:
    "0x0x60806040526120cd80380380610014816101f8565b9283398101906020818303126101f4578051906001600160401b0382116101f4570181601f820112156101f4578051906001600160401b0382116101e057610065601f8301601f19166020016101f8565b92828452602083830101116101f457815f9260208093018386015e8301015280516001600160401b0381116101e057600254600181811c911680156101d6575b60208210146101c257601f811161015f575b50602091601f82116001146100ff579181925f926100f4575b50508160011b915f199060031b1c1916176002555b604051611eaf908161021e8239f35b015190505f806100d0565b601f1982169260025f52805f20915f5b8581106101475750836001951061012f575b505050811b016002556100e5565b01515f1960f88460031b161c191690555f8080610121565b9192602060018192868501518155019401920161010f565b60025f527f405787fa12a823e0f2b7631cc41b3ba8828b3321ca811111fa75cd3aa3bb5ace601f830160051c810191602084106101b8575b601f0160051c01905b8181106101ad57506100b7565b5f81556001016101a0565b9091508190610197565b634e487b7160e01b5f52602260045260245ffd5b90607f16906100a5565b634e487b7160e01b5f52604160045260245ffd5b5f80fd5b6040519190601f01601f191682016001600160401b038111838210176101e05760405256fe608080604052600436101561001c575b50361561001a575f80fd5b005b5f905f3560e01c908163010a38f51461142f575080630eec02cb14611259578063282617f5146107b85780632edd47f9146112295780632fdcfbd214610dd25780634f7d1d5814610d3757806357df844b14610c9c5780635d1c8ae514610ad6578063796d7f561461093c5780637b47ec1a146108d957806383894548146108b3578063862b092b146107d35780638d570a27146107b8578063a4f29aad14610710578063c634d0321461068e578063d19b9b7514610669578063d456ba9d1461065a578063e2f5df8c146106255763f3a902db0361000f57346104b85760803660031901126104b857600435906024356044356001600160401b0381116106215761012c903690600401611579565b9060643561014161013b611983565b15611687565b5f8061017561018c610151611797565b604051928391632d839cb360e21b6020840152604060248401526064830190611663565b62989680604483015203601f1981018352826114b8565b602081519101620deba65afa503a6298968002936298968085043a0361060d574785116105f5575b6101c04786111561181f565b6101c8611ab6565b966001600160a01b03881693843b156104e8576040516339357f8d60e01b81528881600481838a5af180156105ea579089916105d5575b50506102559061021561021061187d565b611ad5565b60409661024e88516102278a826114b8565b601581527414d048185cde5b98d1195c1b1bde4e881cdd185c9d605a1b6020820152611ad5565b369161160f565b90610288865161026588826114b8565b6011815270185cde5b98d1195c1b1bde4814d213d495607a1b6020820152611ad5565b6102bc865161029788826114b8565b6013815272185cde5b98d1195c1b1bde4c4e881cdd185c9d606a1b6020820152611ad5565b801561057a576005811015610526578151602083012061ffff8210156104ec57889971ffffffffffffffffffffffffffffffffffff91885190602082019260ff60f81b84526bffffffffffffffffffffffff199060601b1660218301528760358301526055820152605581526103336075826114b8565b519020169061ffff60901b9060901b1617915f806103b86103d2895161035a6060826114b8565b602981527f6173796e634465706c6f793a2076616c75653d255f2c20636f6e7472616374416020820152686464726573733d255f60b81b8b8201528a5192839163038fd88960e31b6020840152606060248401526084830190611663565b86604483015288606483015203601f1981018352826114b8565b602081519101620deba65afa50843b156104e85761043a938893875195869485938493631087ab7b60e31b855260048501528760248501523060448501528760648501528760848501528560a485015260c484015261010060e4840152610104830190611663565b0391865af180156104de579085916104c9575b5050610461478461045c6118a9565b611b02565b803b156104c45783906024835180958193631e4b5e4960e31b83526298968060048401525af19081156104bb57506104a3575b506104a06102106118f9565b80f35b816104ad916114b8565b6104b857805f610494565b80fd5b513d84823e3d90fd5b505050fd5b816104d3916114b8565b6104c457835f61044d565b83513d87823e3d90fd5b8780fd5b865162461bcd60e51b8152602060048201526013602482015272536861726420696420697320746f6f2062696760681b6044820152606490fd5b855162461bcd60e51b815260206004820152602760248201527f6173796e634465706c6f793a2063616c6c20746f206e6f6e2d6578697374696e60448201526619c81cda185c9960ca1b6064820152608490fd5b855162461bcd60e51b815260206004820152602e60248201527f6173796e634465706c6f793a2063616c6c20746f206d61696e2073686172642060448201526d1a5cc81b9bdd08185b1b1bddd95960921b6064820152608490fd5b816105df916114b8565b6104e857875f6101ff565b6040513d8b823e3d90fd5b6106084786306106036117c8565b611a4f565b6101b4565b634e487b7160e01b86526011600452602486fd5b8280fd5b5060203660031901126104b8576004356001600160401b03811161065657610651903690600401611579565b505080f35b5080fd5b50806003193601126104b85780f35b50346104b857806003193601126104b85760206106863030611dd2565b604051908152f35b50346104b85760203660031901126104b8576106ab61013b611983565b806001600160a01b036106bc611a0f565b16803b1561070d5781809160246040518094819363140e25ad60e31b835260043560048401525af18015610702576106f15750f35b816106fb916114b8565b6104b85780f35b6040513d84823e3d90fd5b50fd5b50346104b85760203660031901126104b857806004356001600160401b03811161070d573660238201121561070d5761075390369060248160040135910161160f565b61075e61013b611983565b6001600160a01b0361076e611a0f565b16803b156107b45760405163a4f29aad60e01b81526020600482015291839183918290849082906107a3906024830190611663565b03925af18015610702576106f15750f35b5050fd5b50346104b8576107c7366115a6565b505050506104a06116f9565b50346104b857806003193601126104b8576004816001600160a01b036107f7611a0f565b166040519283809263862b092b60e01b82525afa908115610702578291610833575b6040516020808252819061082f90820185611663565b0390f35b90503d8083833e61084481836114b8565b810190602081830312610621578051906001600160401b0382116108af570181601f820112156106215780519061087a826115f4565b9261088860405194856114b8565b828452602083830101116108af578161082f949260208093018386015e830101525f610819565b8380fd5b50346104b85760203660031901126104b85760206106866108d2611447565b3090611dd2565b50346104b85760203660031901126104b8576108f661013b611983565b806001600160a01b03610907611a0f565b16803b1561070d57818091602460405180948193630852cd8d60e31b835260043560048401525af18015610702576106f15750f35b50346104b85760403660031901126104b8576024356001600160401b0381116106565761096d903690600401611579565b916040518192600254948560011c60018716968715610acc575b602082108814610ab857818552602097908115610a9c5750600114610a49575b506109c18392610a049261024e87966109f69903866114b8565b6040519586916109dc89840195606087526080850190611663565b6004356040850152838103601f1901606085015290611663565b03601f1981018652856114b8565b8193519060fe5afa610a1d610a17611768565b91611920565b805180610a31575b50506040519015158152f35b610a4292508101830190830161196b565b5f80610a25565b600285529450837f405787fa12a823e0f2b7631cc41b3ba8828b3321ca811111fa75cd3aa3bb5ace5b868210610a8857508301860194506109c16109a7565b805485830189015290870190600101610a72565b60ff19168886015250151560051b8301860194506109c16109a7565b634e487b7160e01b86526022600452602486fd5b90607f1690610987565b50346104b85760e03660031901126104b857610af0611447565b90610af961145d565b91610b02611473565b926064356001600160401b0381116108af57610b229036906004016114d9565b9060a4356001600160401b038111610c9857610b42903690600401611579565b9160c43593610b5261013b611983565b5f80610b62610b76610151611797565b8a604483015203601f1981018352826114b8565b602081519101620deba65afa503a8502958587043a1486151715610c84578798478811610c71575b610baa4789111561181f565b6001600160a01b03610bba611ab6565b1695863b15610c62576040516339357f8d60e01b81528a81600481838c5af1908115610c66578b91610c4d575b5050610c0695610bfc9161024e61021061187d565b9360843592611b4b565b610c13478461045c6118a9565b803b156104c457602484926040519485938492631e4b5e4960e31b845260048401525af18015610702576104a357506104a06102106118f9565b81610c57916114b8565b610c6257895f610be7565b8980fd5b6040513d8d823e3d90fd5b610c7f4789306106036117c8565b610b9e565b634e487b7160e01b88526011600452602488fd5b8480fd5b50346104b857806003193601126104b85760249060206001600160a01b03610cc2611a0f565b16604051938480926339370aa960e21b82523060048301525afa908115610d2b5790610cf4575b602090604051908152f35b506020813d602011610d23575b81610d0e602093836114b8565b81010312610d1f5760209051610ce9565b5f80fd5b3d9150610d01565b604051903d90823e3d90fd5b50346104b85760803660031901126104b85780610d52611447565b606435906001600160401b0382116107b457610d7383923690600401611645565b90610d7f61013b611983565b6020825192019060443590602435f1610d96611768565b5015610d9f5780f35b60405162461bcd60e51b815260206004820152600b60248201526a10d85b1b0819985a5b195960aa1b6044820152606490fd5b50346104b85760603660031901126104b857610dec611447565b90610df561145d565b91610e0161013b611983565b5f80610e11610e28610151611797565b6207a120604483015203601f1981018352826114b8565b602081519101620deba65afa503a6207a12002906207a12082043a0361121557478211611202575b610e5c4783111561181f565b6001600160a01b03610e6c611ab6565b16803b156108af576040516339357f8d60e01b8152848160048183865af180156111f7579085916111e2575b5050610ea561021061187d565b604091825195610eb584886114b8565b60018752601f198401865b8181106111c0575050835190610ed582611489565b6001600160a01b031681526044356020820152610ef187611a2e565b52610efb86611a2e565b508251602091610f0b83836114b8565b86825261ffff855191610f1f6060846114b8565b602883527f6173796e6343616c6c57697468546f6b656e733a206473743d255f2c2063616c85840152676c446174613d255f60c01b878401525f80610f7d89519563d442a9e960e01b89880152606060248801526084870190611663565b6001600160a01b038416604487018190528682036023190160648801529590610fba908290610fac908a611663565b03601f1981018352826114b8565b8781519101620deba65afa5060901c16801561115d576005111561110157833b156110fd5791845192634c3c113160e11b845261014484019060048501528760248501528760448501528760648501528760848501528760a485015261014060c48501528851809152816101648501990191885b8281106110d757505050508180611053889989946003198483030160e4850152611663565b8361010483015283610124830152038183865af180156104de579085916110c2575b5050611084478461045c6118a9565b803b156104c45783906024835180958193631e4b5e4960e31b83526207a12060048401525af19081156104bb57506104a357506104a06102106118f9565b816110cc916114b8565b6104c457835f611075565b835180516001600160a01b03168c528201518b830152998701999281019260010161102e565b8680fd5b845162461bcd60e51b815260048101849052602f60248201527f6173796e6343616c6c57697468546f6b656e733a2063616c6c20746f206e6f6e60448201526e0b595e1a5cdd1a5b99c81cda185c99608a1b6064820152608490fd5b855162461bcd60e51b815260048101859052603660248201527f6173796e6343616c6c57697468546f6b656e733a2063616c6c20746f206d61696044820152751b881cda185c99081a5cc81b9bdd08185b1b1bddd95960521b6064820152608490fd5b60209086516111ce81611489565b898152898382015282828c01015201610ec0565b816111ec916114b8565b6108af57835f610e98565b6040513d87823e3d90fd5b6112104783306106036117c8565b610e50565b634e487b7160e01b83526011600452602483fd5b5060203660031901126104b8576004356001600160401b03811161065657611255903690600401611645565b5080f35b5034610d1f5760c0366003190112610d1f57611273611447565b9061127c61145d565b611284611473565b906064356001600160401b038111610d1f576112a49036906004016114d9565b9060a4356001600160401b038111610d1f576112c4903690600401611579565b9290956112d261013b611983565b6112dd61013b611983565b5f806112ed611305610151611797565b6301c9c380604483015203601f1981018352826114b8565b602081519101620deba65afa503a6301c9c38002946301c9c38086043a0361141b57478611611408575b61133b4787111561181f565b6001600160a01b0361134b611ab6565b1694853b15610d1f576040516339357f8d60e01b81525f81600481838b5af180156113fd576113d9575b5090610bfc889961138e9695949361024e61021061187d565b61139b478361045c6118a9565b803b156107b4578290602460405180948193631e4b5e4960e31b83526301c9c38060048401525af18015610702576104a357506104a06102106118f9565b61138e959493929198505f6113ed916114b8565b610bfc5f98919293949550611375565b6040513d5f823e3d90fd5b6114164787306106036117c8565b61132f565b634e487b7160e01b5f52601160045260245ffd5b34610d1f575f366003190112610d1f57602090308152f35b600435906001600160a01b0382168203610d1f57565b602435906001600160a01b0382168203610d1f57565b604435906001600160a01b0382168203610d1f57565b604081019081106001600160401b038211176114a457604052565b634e487b7160e01b5f52604160045260245ffd5b90601f801991011681019081106001600160401b038211176114a457604052565b81601f82011215610d1f578035906001600160401b0382116114a45760208260051b019261150a60405194856114b8565b82845260208085019360061b83010191818311610d1f57602001925b828410611534575050505090565b604084830312610d1f576040519061154b82611489565b8435906001600160a01b0382168203610d1f5782602092604094528287013583820152815201930192611526565b9181601f84011215610d1f578235916001600160401b038311610d1f5760208381860195010111610d1f57565b6080906003190112610d1f576004356001600160a01b0381168103610d1f57906024356001600160a01b0381168103610d1f57906044356001600160a01b0381168103610d1f579060643590565b6001600160401b0381116114a457601f01601f191660200190565b92919261161b826115f4565b9161162960405193846114b8565b829481845281830111610d1f578281602093845f960137010152565b9080601f83011215610d1f578160206116609335910161160f565b90565b805180835260209291819084018484015e5f828201840152601f01601f1916010190565b1561168e57565b60405162461bcd60e51b815260206004820152603a60248201527f547279696e6720746f2063616c6c2065787465726e616c2066756e6374696f6e60448201527f207769746820696e7465726e616c207472616e73616374696f6e0000000000006064820152608490fd5b6001600160a01b03611709611a0f565b16330361171257565b60405162461bcd60e51b815260206004820152602860248201527f4f6e6c7920546f6b656e4d616e616765722063616e2063616c6c207468697320604482015267333ab731ba34b7b760c11b6064820152608490fd5b3d15611792573d90611779826115f4565b9161178760405193846114b8565b82523d5f602084013e565b606090565b604051906117a66040836114b8565b60138252724153594e432053544152543a206761733d255f60681b6020830152565b604051906117d76060836114b8565b603382527273656e643d255f2c2062616c616e63653d255f60681b6040837f4153594e43204641494c45443a20616464723d255f2c2076616c75655f746f5f60208201520152565b1561182657565b60405162461bcd60e51b815260206004820152602960248201527f4e6f7420656e6f7567682062616c616e636520746f2073656e64206173796e63604482015268206d6573736167657360b81b6064820152608490fd5b6040519061188c6040836114b8565b600e82526d4153594e432052554e20424f445960901b6020830152565b604051906118b86060836114b8565b602c82526b2c2062616c616e63653d255f60a01b6040837f4153594e432046494e414c495a453a2076616c75655f746f5f73656e643d255f60208201520152565b604051906119086040836114b8565b60098252681054d65390c811539160ba1b6020830152565b1561192757565b606460405162461bcd60e51b815260206004820152602060248201527f507265636f6d70696c656420636f6e74726163742063616c6c206661696c65646044820152fd5b90816020910312610d1f57518015158103610d1f5790565b5f80606051608060ff5afa611999610a17611768565b8051156119b357806020806116609351830101910161196b565b60405162461bcd60e51b815260206004820152602e60248201527f2749535f494e5445524e414c5f5452414e53414354494f4e272072657475726e60448201526d7320696e76616c6964206461746160901b6064820152608490fd5b3061ffff60901b16714444444444444444444444444444444444441790565b805115611a3b5760200190565b634e487b7160e01b5f52603260045260245ffd5b611aa790611a7f925f958695604051958694637c7a8d8f60e11b60208701526080602487015260a4860190611663565b6001600160a01b0390931660448501526064840152608483015203601f1981018352826114b8565b602081519101620deba65afa50565b3061ffff60901b16713333333333333333333333333333333333331790565b5f610fac611aa7829360405192839163104c13eb60e21b6020840152602060248401526044830190611663565b611aa7611b32915f9493859460405194859363ca47c4eb60e01b6020860152606060248601526084850190611663565b916044840152606483015203601f1981018352826114b8565b94909493919361ffff60405191611b636060846114b8565b602883527f6173796e6343616c6c57697468546f6b656e733a206473743d255f2c2063616c6020840152676c446174613d255f60c01b60408401525f80611bc56040519563d442a9e960e01b6020880152606060248801526084870190611663565b6001600160a01b038416604487018190528682036023190160648801529590611bf4908290610fac908a611663565b602081519101620deba65afa5060901c168015611d6e5760051115611d11576001600160a01b03611c23611ab6565b1694853b15610d1f57604051634c3c113160e11b815260048101929092526001600160a01b03968716602483015290951660448601525f606486018190526084860181905260a4860184905261014060c48701528251610144870181905286949361016486019392602090910191905b818110611ce3575050509183611cb881935f97956003198483030160e4850152611663565b866101048301528661012483015203925af180156113fd57611cd75750565b5f611ce1916114b8565b565b825180516001600160a01b031686526020908101518187015289975060409095019490920191600101611c93565b60405162461bcd60e51b815260206004820152602f60248201527f6173796e6343616c6c57697468546f6b656e733a2063616c6c20746f206e6f6e60448201526e0b595e1a5cdd1a5b99c81cda185c99608a1b6064820152608490fd5b60405162461bcd60e51b815260206004820152603660248201527f6173796e6343616c6c57697468546f6b656e733a2063616c6c20746f206d61696044820152751b881cda185c99081a5cc81b9bdd08185b1b1bddd95960521b6064820152608490fd5b9061ffff8260901c1661ffff3060901c1603611e6a5760209060446001600160a01b03611dfd611a0f565b60405163d4fac45d60e01b81526001600160a01b03968716600482015295909316602486015284928391165afa9081156113fd575f91611e3b575090565b90506020813d602011611e62575b81611e56602093836114b8565b81010312610d1f575190565b3d9150611e49565b60405162461bcd60e51b815260206004820152601e60248201527f746f6b656e42616c616e63653a2063726f73732d73686172642063616c6c00006044820152606490fd",
  abi: abi,
  args: [pubKey, smartAccountAddress],
  value: 10000000n,
  salt: 400n,
  shardId: 1,
});

const receipts = await tx.wait();

if (receipts.some((receipt: ProcessedReceipt) => !receipt.success)) {
  throw new Error("Contract deployment failed");
}

console.log("Another smart account deployed successfully");
const code = await client.getCode(address, "latest");

console.log("code", bytesToHex(code));
