import type { Abi } from "abitype";
import {
  CheckReceiptSuccess,
  SmartAccountV1,
  bytesToHex,
  externalDeploymentTransaction,
  waitTillCompleted,
} from "../../src/index.js";
import { generatePublicKey, generateTestSmartAccount, newClient, topUpTest } from "./helpers.js";

const client = newClient();

test("Deploy through smart account", async ({ expect }) => {
  const smartAccount = await generateTestSmartAccount();

  const gasPrice = await client.getGasPrice(1);
  const pubKey = generatePublicKey();

  const abi = [
    {
      inputs: [
        { internalType: "bytes", name: "_pubkey", type: "bytes" },
        { internalType: "address", name: "_owner", type: "address" },
      ],
      stateMutability: "payable",
      type: "constructor",
    },
  ] as Abi;
  const { address, tx } = await smartAccount.deployContract({
    bytecode:
      "0x60806040526125328038038061001481610342565b9283398101906020818303126102f2578051906001600160401b0382116102a2570181601f82011215610249578051906001600160401b0382116101e057610065601f8301601f1916602001610342565b92828452602083830101116101f457815f9260208093018386015e8301015280516001600160401b0381116101e057600254600181811c911680156101d6575b60208210146101c257601f811161015f575b50602091601f82116001146100ff579181925f926100f4575b50508160011b915f199060031b1c1916176002555b6040516121ca90816103688239f35b015190505f806100d0565b601f1982169260025f52805f20915f5b8581106101475750836001951061012f575b505050811b016002556100e5565b01515f1960f88460031b161c191690555f8080610121565b9192602060018192868501518155019401920161010f565b60025f527f405787fa12a823e0f2b7631cc41b3ba8828b3321ca811111fa75cd3aa3bb5ace601f830160051c810191602084106101b8575b601f0160051c01905b8181106101ad57506100b7565b5f81556001016101a0565b9091508190610197565b634e487b7160e01b5f52602260045260245ffd5b90607f16906100a5565b634e487b7160e01b5f52604160045260245ffd5b60405162461bcd60e51b815260206004820152602760248201527f414249206465636f64696e673a20696e76616c69642062797465206172726179604482015266040d8cadccee8d60cb1b6064820152608490fd5b60405162461bcd60e51b815260206004820152602b60248201527f414249206465636f64696e673a20696e76616c69642063616c6c64617461206160448201526a1c9c985e481bd9999cd95d60aa1b6064820152608490fd5b60405162461bcd60e51b815260206004820152602260248201527f414249206465636f64696e673a20696e76616c6964207475706c65206f666673604482015261195d60f21b6064820152608490fd5b60405162461bcd60e51b815260206004820152602260248201527f414249206465636f64696e673a207475706c65206461746120746f6f2073686f6044820152611c9d60f21b6064820152608490fd5b6040519190601f01601f191682016001600160401b038111838210176101e05760405256fe6080604052600436101561006d575b361561006b5760405162461bcd60e51b815260206004820152602960248201527f556e6b6e6f776e207369676e617475726520616e64206e6f2066616c6c6261636044820152681ac81919599a5b995960ba1b6064820152608490fd5b005b5f5f3560e01c8063010a38f51461144b5780630eec02cb1461127a578063282617f5146107fd5780632edd47f91461124a5780632fdcfbd214610dff5780634f7d1d5814610d6457806357df844b14610ccd5780635d1c8ae514610b1b578063796d7f56146109815780637b47ec1a1461091e57806383894548146108f9578063862b092b146108185780638d570a27146107fd578063a4f29aad14610755578063c634d032146106e1578063d19b9b75146106bd578063d456ba9d146106ae578063e2f5df8c1461067d5763f3a902db14610149575061000e565b3461067857608036600319011261050c576024356004356044356001600160401b0381116106735761017f903690600401611793565b909260643561019561018f611c9e565b1561194f565b5f806101c96101e06101a5611ab2565b604051928391632d839cb360e21b602084015260406024840152606483019061192b565b62989680604483015203601f198101835282611623565b602081519101620deba65afa503a6298968002936298968085043a0361065f57478511610647575b61021447861115611b3a565b61021c611dd1565b6001600160a01b03811696909190873b1561051a576040516339357f8d60e01b815289908181600481838e5af1801561063c57610627575b50506102aa9061026a610265611b98565b611df0565b6040966102a3885161027c8a82611623565b601581527414d048185cde5b98d1195c1b1bde4e881cdd185c9d605a1b6020820152611df0565b36916118d7565b916102dd86516102ba8882611623565b6011815270185cde5b98d1195c1b1bde4814d213d495607a1b6020820152611df0565b61031186516102ec8882611623565b6013815272185cde5b98d1195c1b1bde4c4e881cdd185c9d606a1b6020820152611df0565b81156105cc576005821015610578578251602084012061ffff83101561053e579071ffffffffffffffffffffffffffffffffffff91875190602082019260ff60f81b84526bffffffffffffffffffffffff199060601b166021830152866035830152605582015260558152610387607582611623565b519020169061ffff60901b9060901b1617905f8061040c61042688516103ae606082611623565b602981527f6173796e634465706c6f793a2076616c75653d255f2c20636f6e7472616374416020820152686464726573733d255f60b81b8a820152895192839163038fd88960e31b602084015260606024840152608483019061192b565b89604483015287606483015203601f198101835282611623565b602081519101620deba65afa50863b1561051a578793610490938593875195869485938493631087ab7b60e31b855260048501528760248501523060448501528760648501528760848501528560a485015260c484015261010060e484015261010483019061192b565b0391895af180156105345761051f575b50506104b447836104af611bc4565b611e1d565b823b1561051a578380936024835180958193631e4b5e4960e31b83526298968060048401525af190811561051157506104f7575b506104f4610265611c14565b80f35b8161050191611623565b61050c57805f6104e8565b6114b5565b513d84823e3d90fd5b611a5f565b8161052991611623565b61050c57835f6104a0565b83513d84823e3d90fd5b865162461bcd60e51b8152602060048201526013602482015272536861726420696420697320746f6f2062696760681b6044820152606490fd5b855162461bcd60e51b815260206004820152602760248201527f6173796e634465706c6f793a2063616c6c20746f206e6f6e2d6578697374696e60448201526619c81cda185c9960ca1b6064820152608490fd5b855162461bcd60e51b815260206004820152602e60248201527f6173796e634465706c6f793a2063616c6c20746f206d61696e2073686172642060448201526d1a5cc81b9bdd08185b1b1bddd95960921b6064820152608490fd5b8161063191611623565b61050c57885f610254565b6040513d84823e3d90fd5b61065a478630610655611ae3565b611d6a565b610208565b634e487b7160e01b87526011600452602487fd5b611505565b611465565b50602036600319011261050c576004356001600160401b038111610673576106a9903690600401611793565b505080f35b508060031936011261050c5780f35b50346106785736600319011261050c5760206106d930306120ed565b604051908152f35b503461067857602036600319011261050c576106fe61018f611c9e565b6001600160a01b0361070e611d2a565b16803b1561051a578180809260246040518094819363140e25ad60e31b835260043560048401525af1801561063c576107445750f35b8161074e91611623565b61050c5780f35b503461067857602036600319011261050c576004356001600160401b03811161067357366023820112156107f8576107979036906024816004013591016118d7565b6107a261018f611c9e565b6001600160a01b036107b2611d2a565b1690813b1561051a57826107e78193829360405194858094819363a4f29aad60e01b835260206004840152602483019061192b565b03925af1801561063c576107445750f35b61159b565b50346106785761080c36611819565b505050506104f46119c1565b5034610678578060031936011261050c576004816001600160a01b0361083c611d2a565b166040519283809263862b092b60e01b82525afa90811561063c578291610878575b604051602080825281906108749082018561192b565b0390f35b90503d8083833e6108898183611623565b81019060208183031261050c578051906001600160401b03821161067357019181601f840112156107f8578251926108c0846118bc565b926108ce6040519485611623565b848452602085830101116108f457836108749460208093018386015e830101525f61085e565b611867565b3461067857602036600319011261050c5760206106d9610917611555565b30906120ed565b503461067857602036600319011261050c5761093b61018f611c9e565b6001600160a01b0361094b611d2a565b16803b1561051a5781808092602460405180948193630852cd8d60e31b835260043560048401525af1801561063c576107445750f35b503461067857604036600319011261050c576024356001600160401b038111610673576109b2903690600401611793565b916040518192600254948560011c60018716968715610b11575b602082108814610afd57818552602097908115610ae15750600114610a8e575b50610a068392610a49926102a38796610a3b990386611623565b604051958691610a218984019560608752608085019061192b565b6004356040850152838103601f190160608501529061192b565b03601f198101865285611623565b8193519060fe5afa610a62610a5c611a30565b91611c3b565b805180610a76575b50506040519015158152f35b610a87925081018301908301611c86565b5f80610a6a565b600285529450837f405787fa12a823e0f2b7631cc41b3ba8828b3321ca811111fa75cd3aa3bb5ace5b868210610acd5750830186019450610a066109ec565b805485830189015290870190600101610ab7565b60ff19168886015250151560051b830186019450610a066109ec565b634e487b7160e01b86526022600452602486fd5b90607f16906109cc565b50346106785760e036600319011261050c57610b35611555565b610b3d61156f565b90610b46611585565b906064356001600160401b03811161067357610b6690369060040161169d565b60a4356001600160401b03811161067357610b85903690600401611793565b94909160c43593610b9761018f611c9e565b5f80610ba7610bbb6101a5611ab2565b8a604483015203601f198101835282611623565b602081519101620deba65afa503a8502958587043a1486151715610cb957478711610ca6575b610bed47881115611b3a565b6001600160a01b03610bfd611dd1565b1697883b1561051a576040516339357f8d60e01b81528a908181600481838f5af1801561063c57610c91575b5050610c4895610c3e916102a3610265611b98565b9360843592611e66565b610c5547836104af611bc4565b823b1561051a578392602484926040519485938492631e4b5e4960e31b845260048401525af1801561063c576104f757506104f4610265611c14565b81610c9b91611623565b61050c57895f610c29565b610cb4478830610655611ae3565b610be1565b634e487b7160e01b89526011600452602489fd5b5034610678578060031936011261050c5760249060206001600160a01b03610cf3611d2a565b16604051938480926339370aa960e21b82523060048301525afa908115610d585790610d25575b602090604051908152f35b506020813d602011610d50575b81610d3f60209383611623565b8101031261050c5760209051610d1a565b3d9150610d32565b604051903d90823e3d90fd5b503461067857608036600319011261050c57610d7e611555565b6064356001600160401b038111610673578291610da08392369060040161190d565b90610dac61018f611c9e565b6020825192019060443590602435f1610dc3611a30565b5015610dcc5780f35b60405162461bcd60e51b815260206004820152600b60248201526a10d85b1b0819985a5b195960aa1b6044820152606490fd5b503461067857606036600319011261050c57610e19611555565b610e2161156f565b610e2c61018f611c9e565b5f80610e3c610e536101a5611ab2565b6207a120604483015203601f198101835282611623565b602081519101620deba65afa503a6207a12002906207a12082043a0361123657478211611223575b610e8747831115611b3a565b6001600160a01b03610e97611dd1565b1692833b1561051a576040516339357f8d60e01b815285908181600481838a5af1801561063c5761120e575b5050610ed0610265611b98565b604091825190610ee08483611623565b60018252601f198401875b8181106111ec575050835190610f00826115f4565b6001600160a01b031681526044356020820152610f1c82611d49565b52610f2681611d49565b508251602092610f368483611623565b87825261ffff855191610f4a606084611623565b602883527f6173796e6343616c6c57697468546f6b656e733a206473743d255f2c2063616c86840152676c446174613d255f60c01b878401525f80610fa889519563d442a9e960e01b8a88015260606024880152608487019061192b565b6001600160a01b038416604487018190528682036023190160648801529590610fe5908290610fd7908a61192b565b03601f198101835282611623565b8881519101620deba65afa5060901c168015611189576005111561112d57863b1561051a5791908793855193634c3c113160e11b855261014485019060048601528560248601528560448601528560648601528560848601528560a486015261014060c48601528351809152816101648601940191865b8883821061110457505050505082611082859382936003198483030160e485015261192b565b8361010483015283610124830152038183895af18015610534576110ef575b50506110b047836104af611bc4565b823b1561051a578380936024835180958193631e4b5e4960e31b83526207a12060048401525af190811561051157506104f757506104f4610265611c14565b816110f991611623565b61050c57835f6110a1565b845180516001600160a01b03168852830151878401528c9850909501949281019260010161105c565b845162461bcd60e51b815260048101859052602f60248201527f6173796e6343616c6c57697468546f6b656e733a2063616c6c20746f206e6f6e60448201526e0b595e1a5cdd1a5b99c81cda185c99608a1b6064820152608490fd5b855162461bcd60e51b815260048101869052603660248201527f6173796e6343616c6c57697468546f6b656e733a2063616c6c20746f206d61696044820152751b881cda185c99081a5cc81b9bdd08185b1b1bddd95960521b6064820152608490fd5b60209086516111fa816115f4565b8a81528a8382015282828701015201610eeb565b8161121891611623565b61050c57845f610ec3565b611231478330610655611ae3565b610e7b565b634e487b7160e01b84526011600452602484fd5b50602036600319011261050c576004356001600160401b0381116106735761127690369060040161190d565b5080f35b50346106785760c036600319011261050c57611294611555565b9061129d61156f565b916112a6611585565b6064356001600160401b038111610673576112c590369060040161169d565b9360a4356001600160401b038111610673576112e5903690600401611793565b9590936112f361018f611c9e565b6112fe61018f611c9e565b5f8061130e6113266101a5611ab2565b6301c9c380604483015203601f198101835282611623565b602081519101620deba65afa503a6301c9c38002936301c9c38085043a0361143757478511611424575b61135c47861115611b3a565b6001600160a01b0361136c611dd1565b1695863b1561051a576040516339357f8d60e01b81525f81600481838c5af18015611419576113f9575b50610c3e906113ad969798996102a3610265611b98565b6113ba47826104af611bc4565b813b1561051a57828092602460405180948193631e4b5e4960e31b83526301c9c38060048401525af1801561063c576104f757506104f4610265611c14565b6113ad969798509061140e5f610c3e93611623565b5f9897965090611396565b6040513d5f823e3d90fd5b611432478630610655611ae3565b611350565b634e487b7160e01b5f52601160045260245ffd5b34611465575f36600319011261050c576020604051308152f35b60405162461bcd60e51b815260206004820152602260248201527f45746865722073656e7420746f206e6f6e2d70617961626c652066756e63746960448201526137b760f11b6064820152608490fd5b60405162461bcd60e51b815260206004820152602260248201527f414249206465636f64696e673a207475706c65206461746120746f6f2073686f6044820152611c9d60f21b6064820152608490fd5b60405162461bcd60e51b815260206004820152602260248201527f414249206465636f64696e673a20696e76616c6964207475706c65206f666673604482015261195d60f21b6064820152608490fd5b600435906001600160a01b038216820361156b57565b5f80fd5b602435906001600160a01b038216820361156b57565b604435906001600160a01b038216820361156b57565b60405162461bcd60e51b815260206004820152602b60248201527f414249206465636f64696e673a20696e76616c69642063616c6c64617461206160448201526a1c9c985e481bd9999cd95d60aa1b6064820152608490fd5b604081019081106001600160401b0382111761160f57604052565b634e487b7160e01b5f52604160045260245ffd5b90601f801991011681019081106001600160401b0382111761160f57604052565b60405162461bcd60e51b815260206004820152602b60248201527f414249206465636f64696e673a20696e76616c69642063616c6c64617461206160448201526a727261792073747269646560a81b6064820152608490fd5b81601f820112156107f8578035906001600160401b03821161160f5760208260051b01926116ce6040519485611623565b82845260208085019360061b8301019181831161178e57602001925b8284106116f8575050505090565b60408483031261173d576040519061170f826115f4565b8435906001600160a01b038216820361156b57826020926040945282870135838201528152019301926116ea565b60405162461bcd60e51b815260206004820152602360248201527f414249206465636f64696e673a20737472756374206461746120746f6f2073686044820152621bdc9d60ea1b6064820152608490fd5b611644565b9181601f840112156107f8578235916001600160401b0383116117c0576020838186019501011161178e57565b60405162461bcd60e51b815260206004820152602b60248201527f414249206465636f64696e673a20696e76616c69642063616c6c64617461206160448201526a0e4e4c2f240d8cadccee8d60ab1b6064820152608490fd5b608090600319011261050c576004356001600160a01b038116810361156b57906024356001600160a01b038116810361156b57906044356001600160a01b038116810361156b579060643590565b60405162461bcd60e51b815260206004820152602760248201527f414249206465636f64696e673a20696e76616c69642062797465206172726179604482015266040d8cadccee8d60cb1b6064820152608490fd5b6001600160401b03811161160f57601f01601f191660200190565b9291926118e3826118bc565b916118f16040519384611623565b8294818452818301116108f4578281602093845f960137010152565b9080601f830112156107f857816020611928933591016118d7565b90565b805180835260209291819084018484015e5f828201840152601f01601f1916010190565b1561195657565b60405162461bcd60e51b815260206004820152603a60248201527f547279696e6720746f2063616c6c2065787465726e616c2066756e6374696f6e60448201527f207769746820696e7465726e616c207472616e73616374696f6e0000000000006064820152608490fd5b6001600160a01b036119d1611d2a565b1633036119da57565b60405162461bcd60e51b815260206004820152602860248201527f4f6e6c7920546f6b656e4d616e616765722063616e2063616c6c207468697320604482015267333ab731ba34b7b760c11b6064820152608490fd5b3d15611a5a573d90611a41826118bc565b91611a4f6040519384611623565b82523d5f602084013e565b606090565b60405162461bcd60e51b815260206004820152602560248201527f54617267657420636f6e747261637420646f6573206e6f7420636f6e7461696e60448201526420636f646560d81b6064820152608490fd5b60405190611ac1604083611623565b60138252724153594e432053544152543a206761733d255f60681b6020830152565b60405190611af2606083611623565b603382527273656e643d255f2c2062616c616e63653d255f60681b6040837f4153594e43204641494c45443a20616464723d255f2c2076616c75655f746f5f60208201520152565b15611b4157565b60405162461bcd60e51b815260206004820152602960248201527f4e6f7420656e6f7567682062616c616e636520746f2073656e64206173796e63604482015268206d6573736167657360b81b6064820152608490fd5b60405190611ba7604083611623565b600e82526d4153594e432052554e20424f445960901b6020830152565b60405190611bd3606083611623565b602c82526b2c2062616c616e63653d255f60a01b6040837f4153594e432046494e414c495a453a2076616c75655f746f5f73656e643d255f60208201520152565b60405190611c23604083611623565b60098252681054d65390c811539160ba1b6020830152565b15611c4257565b606460405162461bcd60e51b815260206004820152602060248201527f507265636f6d70696c656420636f6e74726163742063616c6c206661696c65646044820152fd5b9081602091031261050c5751801515810361156b5790565b5f80606051608060ff5afa611cb4610a5c611a30565b805115611cce578060208061192893518301019101611c86565b60405162461bcd60e51b815260206004820152602e60248201527f2749535f494e5445524e414c5f5452414e53414354494f4e272072657475726e60448201526d7320696e76616c6964206461746160901b6064820152608490fd5b3061ffff60901b16714444444444444444444444444444444444441790565b805115611d565760200190565b634e487b7160e01b5f52603260045260245ffd5b611dc290611d9a925f958695604051958694637c7a8d8f60e11b60208701526080602487015260a486019061192b565b6001600160a01b0390931660448501526064840152608483015203601f198101835282611623565b602081519101620deba65afa50565b3061ffff60901b16713333333333333333333333333333333333331790565b5f610fd7611dc2829360405192839163104c13eb60e21b602084015260206024840152604483019061192b565b611dc2611e4d915f9493859460405194859363ca47c4eb60e01b602086015260606024860152608485019061192b565b916044840152606483015203601f198101835282611623565b94909493919361ffff60405191611e7e606084611623565b602883527f6173796e6343616c6c57697468546f6b656e733a206473743d255f2c2063616c6020840152676c446174613d255f60c01b60408401525f80611ee06040519563d442a9e960e01b602088015260606024880152608487019061192b565b6001600160a01b038416604487018190528682036023190160648801529590611f0f908290610fd7908a61192b565b602081519101620deba65afa5060901c168015612089576005111561202c576001600160a01b03611f3e611dd1565b1694853b1561051a57604051634c3c113160e11b815260048101929092526001600160a01b03968716602483015290951660448601525f606486018190526084860181905260a4860184905261014060c48701528251610144870181905286949361016486019392602090910191905b818110611ffe575050509183611fd381935f97956003198483030160e485015261192b565b866101048301528661012483015203925af1801561141957611ff25750565b5f611ffc91611623565b565b825180516001600160a01b031686526020908101518187015289975060409095019490920191600101611fae565b60405162461bcd60e51b815260206004820152602f60248201527f6173796e6343616c6c57697468546f6b656e733a2063616c6c20746f206e6f6e60448201526e0b595e1a5cdd1a5b99c81cda185c99608a1b6064820152608490fd5b60405162461bcd60e51b815260206004820152603660248201527f6173796e6343616c6c57697468546f6b656e733a2063616c6c20746f206d61696044820152751b881cda185c99081a5cc81b9bdd08185b1b1bddd95960521b6064820152608490fd5b9061ffff8260901c1661ffff3060901c16036121855760209060446001600160a01b03612118611d2a565b60405163d4fac45d60e01b81526001600160a01b03968716600482015295909316602486015284928391165afa908115611419575f91612156575090565b90506020813d60201161217d575b8161217160209383611623565b8101031261050c575190565b3d9150612164565b60405162461bcd60e51b815260206004820152601e60248201527f746f6b656e42616c616e63653a2063726f73732d73686172642063616c6c00006044820152606490fd",
    abi: abi,
    args: [pubKey, smartAccount.address],
    value: 10000000n,
    feeCredit: 20000000n * gasPrice,
    salt: 400n,
    shardId: 1,
  });

  const receipts = await tx.wait({ waitTillMainShard: true });

  expect(receipts.some((receipt) => !CheckReceiptSuccess(receipt))).toBe(false);

  expect(receipts.length).toBeDefined();
  expect(receipts[0].success).toBe(true);

  const code = await client.getCode(address, "latest");

  expect(code).toBeDefined();
  expect(code.length).toBeGreaterThan(10);
});

test("External deployment", async ({ expect }) => {
  const chainId = await client.chainId();
  const gasPrice = await client.getGasPrice(1);

  const pubKey = generatePublicKey();
  const deploymentTransaction = externalDeploymentTransaction(
    {
      salt: 100n,
      shard: 1,
      bytecode: SmartAccountV1.code,
      abi: SmartAccountV1.abi,
      args: [pubKey],
      feeCredit: 10_000_000n * gasPrice,
    },
    chainId,
  );
  const addr = bytesToHex(deploymentTransaction.to);
  expect(addr).toBeDefined();

  await topUpTest(addr);

  const hash = await deploymentTransaction.send(client);

  const receipts = await waitTillCompleted(client, hash);

  expect(receipts.some((receipt) => !receipt.success)).toBe(false);

  const code = await client.getCode(addr, "latest");

  expect(code).toBeDefined();
  expect(code.length).toBeGreaterThan(10);
});

test("External failed deployment", async ({ expect }) => {
  const chainId = await client.chainId();
  const gasPrice = await client.getGasPrice(1);

  const pubKey = generatePublicKey();
  const deploymentTransaction = externalDeploymentTransaction(
    {
      salt: 100n,
      shard: 1,
      bytecode: SmartAccountV1.code,
      abi: SmartAccountV1.abi,
      args: [pubKey],
      feeCredit: 10000000000000000000000000000000n * gasPrice,
    },
    chainId,
  );
  const addr = bytesToHex(deploymentTransaction.to);
  expect(addr).toBeDefined();

  await topUpTest(addr, "NIL");

  const hash = await deploymentTransaction.send(client);

  const receipts = await waitTillCompleted(client, hash);

  expect(receipts.some((receipt) => !CheckReceiptSuccess(receipt))).toBe(true);
});
